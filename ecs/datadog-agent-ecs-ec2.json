{
  "family": "masafumi-kashiwagi-ecs-ec2",
  "networkMode": "awsvpc",
  "containerDefinitions": [
    {
      "name": "datadog-agent",
      "image": "public.ecr.aws/datadog/agent:latest",
      "cpu": 100,
      "memory": 512,
      "essential": true,
      "mountPoints": [
        {
          "containerPath": "/var/run/docker.sock",
          "sourceVolume": "docker_sock",
          "readOnly": true
        },
        {
          "containerPath": "/host/sys/fs/cgroup",
          "sourceVolume": "cgroup",
          "readOnly": true
        },
        {
          "containerPath": "/host/proc",
          "sourceVolume": "proc",
          "readOnly": true
        }
      ],
      "environment": [
        {
          "name": "DD_API_KEY",
          "value": "{DD_API_KEY}"
        },
        {
          "name": "DD_SITE",
          "value": "datadoghq.com"
        },
        {
          "name": "DD_APM_ENABLED",
          "value": "true"
        }
      ],
      "healthCheck": {
	  "retries": 3,
	  "command": ["CMD-SHELL","agent health"],
	  "timeout": 5,
	  "interval": 30,
	  "startPeriod": 15
      },
      "logConfiguration": {
          "logDriver": "awslogs",
          "options": {
              "awslogs-group": "masafumi-kashiwagi-ecs-ec2",
              "awslogs-region": "ap-northeast-1",
              "awslogs-create-group": "true",
              "awslogs-stream-prefix": "mk"
          }
      }
    },
    {
        "name": "php-fpm",
        "image": "public.ecr.aws/b1o7r7e0/masafumi.kashiwagi/php-fpm:with-ddtracer-4",
	"cpu": 100,
	"memory": 512,
        "essential": true,
        "environment": [
            {
                "name": "DD_ENV",
                "value": "ecs"
            }
        ],
	"logConfiguration": {
            "logDriver": "awslogs",
            "options": {
                "awslogs-group": "masafumi-kashiwagi-php-fpm",
                "awslogs-region": "ap-northeast-1",
                "awslogs-create-group": "true",
                "awslogs-stream-prefix": "mk"
            }
        }
    },
    {
        "name": "nginx",
        "image": "public.ecr.aws/b1o7r7e0/masafumi.kashiwagi/nginx:1",
	"cpu": 100,
	"memory": 512,
        "essential": true,
        "environment": [
        ],
	"logConfiguration": {
            "logDriver": "awslogs",
            "options": {
                "awslogs-group": "masafumi-kashiwagi-nginx",
                "awslogs-region": "ap-northeast-1",
                "awslogs-create-group": "true",
                "awslogs-stream-prefix": "mk"
            }
        }
    },
    {
        "name": "apache-bench",
        "image": "public.ecr.aws/b1o7r7e0/masafumi.kashiwagi/apache-bench:1",
	"cpu": 100,
	"memory": 512,
        "essential": true,
        "environment": [
        ],
	"logConfiguration": {
	    "logDriver": "awsfirelens",
	    "options": {
		"Name": "datadog",
		"apikey": "{DD_API_KEY}",
		"Host": "http-intake.logs.datadoghq.com",
		"dd_service": "apache-bench",
		"dd_source": "apache-bench",
		"dd_message_key": "log",
		"dd_tags": "ecs:ec2",
		"TLS": "on",
		"provider": "ecs"
	    }
	}
    },
    {
	"name": "log_router",
	"image": "amazon/aws-for-fluent-bit:stable",
	"cpu": 100,
	"memory": 512,
	"essential": true,
	"firelensConfiguration": {
	    "type": "fluentbit",
	    "options": { "enable-ecs-log-metadata": "true" }
	},
	"logConfiguration": {
            "logDriver": "awslogs",
            "options": {
                "awslogs-group": "masafumi-kashiwagi-log_router",
                "awslogs-region": "ap-northeast-1",
                "awslogs-create-group": "true",
                "awslogs-stream-prefix": "mk"
            }
        }
    }
  ],
  "volumes": [
    {
      "host": {
        "sourcePath": "/var/run/docker.sock"
      },
      "name": "docker_sock"
    },
    {
      "host": {
        "sourcePath": "/proc/"
      },
      "name": "proc"
    },
    {
      "host": {
        "sourcePath": "/sys/fs/cgroup/"
      },
      "name": "cgroup"
    }
  ]
}
